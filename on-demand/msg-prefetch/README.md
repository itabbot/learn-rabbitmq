# 知识：RabbitMQ 的 “消息预取” 特性

## 1. 概述

RabbitMQ 的 “消息预取”（Message Prefetch）特性是指在消费者与 RabbitMQ 之间的消息传递过程中，消费者可以一次性预取（或批量获取）多个消息进行处理。有以下应用场景：

- 消费速率控制： 默认情况下，当消费者不设置 “消息预取” 时，消费者会快速获取所有消息，而不需要等待确认应答。如果设置了 “消息预取” 并且在处理消息时未发送确认消息（未应答）时，RabbitMQ 将不会继续向该消费者发送新的消息。这可以有效的控制消费者的消费速率，以防消息过载。
- 负载均衡： 在竞争消费者模式中，默认情况下，RabbitMQ 会将每条消息按顺序发送给消费者，平均而言，每个消费者都会收到相同数量的消息。当消息的处理繁重程度不均匀时，就会出现不同消费者的负载不均匀情况。消费者设置了 “消息预取” 并设置为较小的值时，如果消费者没有处理完消息，则不会继续获取，可以实现每个消费者在负载均衡的情况下公平地获取消息。

## 2. 体验

1. 生产消息（[producer.js](producer.js)）

```shell
$ node ./producer.js
已发送6条消息
```

2. 消费消息（[consumer.js](consumer.js)）

可以看到当消费者处理完一批数据后，才会获取下一批：

```shell
$ node ./consumer.js
等待消息中...
[23:40:09] 收到消息: 消息1
[23:40:09] 收到消息: 消息2
[23:40:11] 收到消息: 消息3
[23:40:11] 收到消息: 消息4
[23:40:13] 收到消息: 消息5
[23:40:13] 收到消息: 消息6
```
